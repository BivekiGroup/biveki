generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ServiceCategory {
  web
  account
  shop
  integrations
  apps
  support
}

enum ClientType {
  INDIVIDUAL // Физлицо
  LEGAL      // Юрлицо/ИП
}

model User {
  id           Int      @id @default(autoincrement()) @map("id")
  name         String   @map("name")
  email        String   @unique @map("email")
  passwordHash String   @map("password_hash")
  createdAt    DateTime @default(now()) @map("created_at")
  isAdmin      Boolean  @default(false) @map("is_admin")
  avatarUrl    String?  @map("avatar_url")

  projects      Project[]
  cases         Case[]
  clientProfile ClientProfile?

  @@map("users")
}

model ClientProfile {
  id        Int        @id @default(autoincrement()) @map("id")
  userId    Int        @unique @map("user_id")
  type      ClientType @map("type")

  // Физлицо
  lastName   String? @map("last_name")
  firstName  String? @map("first_name")
  middleName String? @map("middle_name")

  // Юрлицо/ИП
  inn           String? @map("inn")
  companyName   String? @map("company_name")
  legalAddress  String? @map("legal_address")

  // Общие реквизиты
  bik           String? @map("bik")
  accountNumber String? @map("account_number")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("client_profiles")
}

model Contact {
  id        Int      @id @default(autoincrement()) @map("id")
  name      String   @map("name")
  email     String   @map("email")
  message   String   @map("message")
  reason    String?  @map("reason")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("contacts")
}

model Project {
  id          Int      @id @default(autoincrement()) @map("id")
  userId      Int      @map("user_id")
  name        String   @map("name")
  description String?  @map("description")
  createdAt   DateTime @default(now()) @map("created_at")

  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  tasks       Task[]
  milestones  Milestone[]
  files       ProjectFile[]

  @@map("projects")
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  REVIEW
  DONE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Task {
  id          Int          @id @default(autoincrement()) @map("id")
  projectId   Int          @map("project_id")
  title       String       @map("title")
  description String?      @map("description")
  status      TaskStatus   @default(TODO) @map("status")
  priority    TaskPriority @default(MEDIUM) @map("priority")
  milestoneId Int?         @map("milestone_id")
  dueDate     DateTime?    @map("due_date")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  milestone   Milestone?   @relation(fields: [milestoneId], references: [id], onDelete: SetNull)

  @@map("tasks")
}

model Milestone {
  id          Int       @id @default(autoincrement()) @map("id")
  projectId   Int       @map("project_id")
  name        String    @map("name")
  description String?   @map("description")
  dueDate     DateTime? @map("due_date")
  createdAt   DateTime  @default(now()) @map("created_at")

  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks       Task[]

  @@map("milestones")
}

model ProjectFile {
  id          Int      @id @default(autoincrement()) @map("id")
  projectId   Int      @map("project_id")
  filename    String   @map("filename")
  url         String   @map("url")
  size        Int      @map("size")
  mimeType    String   @map("mime_type")
  createdAt   DateTime @default(now()) @map("created_at")

  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("project_files")
}

model Case {
  id        Int              @id @default(autoincrement()) @map("id")
  authorId  Int              @map("author_id")
  slug      String           @unique @map("slug")
  title     String           @map("title")
  service   ServiceCategory  @map("service")
  summary   String           @map("summary")
  problem   String           @map("problem")
  solution  String           @map("solution")
  result    String           @map("result")
  metrics   String[]         @default([]) @map("metrics")
  // Extra presentation fields
  client    String?          @map("client")
  tags      String[]         @default([]) @map("tags")
  tech      String[]         @default([]) @map("tech")
  year      Int?             @map("year")
  externalUrl String?        @map("external_url")
  published Boolean          @default(false) @map("published")
  createdAt DateTime         @default(now()) @map("created_at")
  updatedAt DateTime         @updatedAt @map("updated_at")

  author    User             @relation(fields: [authorId], references: [id], onDelete: SetNull)
  media     CaseMedia[]

  @@map("cases")
}

enum MediaType {
  image
  video
}

model CaseMedia {
  id       Int       @id @default(autoincrement()) @map("id")
  caseId   Int       @map("case_id")
  type     MediaType @map("type")
  src      String    @map("src")
  alt      String?   @map("alt")
  poster   String?   @map("poster")
  order    Int       @default(0) @map("order")

  case     Case      @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@map("case_media")
  @@index([caseId, order])
}
